$(document).ready(function() {
  function r(r, e, a) {
    clearInterval(h), c = 0, d = t = a, m = r * e, $("#restMine").text(t), mineArr = new Array(r + 2), $.each(mineArr, function(r) { mineArr[r] = new Array(e + 2) });
    for (var s = 0; r + 2 > s; s++)
      for (var n = 0; e + 2 > n; n++) mineArr[s][n] = 0;
    for (; a > 0;) {
      var s = Math.ceil(Math.random() * r),
        n = Math.ceil(Math.random() * e); - 1 != mineArr[s][n] && (mineArr[s][n] = -1, a--)
    }
    for (var s = 1; r >= s; s++)
      for (var n = 1; e >= n; n++) 0 == mineArr[s][n] && (-1 == mineArr[s - 1][n - 1] && mineArr[s][n]++, -1 == mineArr[s - 1][n] && mineArr[s][n]++, -1 == mineArr[s - 1][n + 1] && mineArr[s][n]++, -1 == mineArr[s][n - 1] && mineArr[s][n]++, -1 == mineArr[s][n + 1] && mineArr[s][n]++, -1 == mineArr[s + 1][n - 1] && mineArr[s][n]++, -1 == mineArr[s + 1][n] && mineArr[s][n]++, -1 == mineArr[s + 1][n + 1] && mineArr[s][n]++);
    for (var i = "", s = 1; s < mineArr.length - 1; s++)
      for (var n = 1; n < mineArr[0].length - 1; n++) i += '<div id="c' + s + "-r" + n + '" style="left:' + 20 * (s - 1) + "px; top:" + 20 * (n - 1) + 'px "class="hidden"></div>';
    $("#main").html(i).width(20 * r).height(20 * e).show(), l = 1
  }

  function e(a, s) {
    var c = $("#c" + a + "-r" + s),
      C = $("#c" + (a - 1) + "-r" + (s - 1)),
      o = $("#c" + a + "-r" + (s - 1)),
      f = $("#c" + (a + 1) + "-r" + (s - 1)),
      v = $("#c" + (a - 1) + "-r" + s),
      A = $("#c" + (a + 1) + "-r" + s),
      g = $("#c" + (a - 1) + "-r" + (s + 1)),
      u = $("#c" + a + "-r" + (s + 1)),
      x = $("#c" + (a + 1) + "-r" + (s + 1));
    if (1 == l) {
      -1 == mineArr[a][s] ? (r(mineArr.length - 2, mineArr[0].length - 2, t), e(a, s)) : mineArr[a][s] > 0 ? !c.hasClass("flag") && c.hasClass("hidden") && (c.removeClass("hidden").html(mineArr[a][s]).addClass("num" + mineArr[a][s]), m--, i(d)) : 0 == mineArr[a][s] && c.hasClass("hidden") && (c.removeClass("hidden"), m--, C.hasClass("hidden") && e(a - 1, s - 1), o.hasClass("hidden") && e(a, s - 1), f.hasClass("hidden") && e(a + 1, s - 1), v.hasClass("hidden") && e(a - 1, s), A.hasClass("hidden") && e(a + 1, s), g.hasClass("hidden") && e(a - 1, s + 1), u.hasClass("hidden") && e(a, s + 1), x.hasClass("hidden") && e(a + 1, s + 1)), l = 2, clearInterval(h);
      var I = 0;
      h = setInterval(function() { I += .1, I = Math.round(10 * I) / 10, $("#time").text(I) }, 100), i(d)
    } else 2 == l ? -1 == mineArr[a][s] ? c.hasClass("flag") || (c.removeClass("hidden").addClass("cbomb"), n()) : mineArr[a][s] > 0 ? !c.hasClass("flag") && c.hasClass("hidden") && (c.removeClass("hidden").html(mineArr[a][s]).addClass("num" + mineArr[a][s]), m--, i(d)) : 0 == mineArr[a][s] && c.hasClass("hidden") && (c.removeClass("hidden"), m--, C.hasClass("hidden") && e(a - 1, s - 1), o.hasClass("hidden") && e(a, s - 1), f.hasClass("hidden") && e(a + 1, s - 1), v.hasClass("hidden") && e(a - 1, s), A.hasClass("hidden") && e(a + 1, s), g.hasClass("hidden") && e(a - 1, s + 1), u.hasClass("hidden") && e(a, s + 1), x.hasClass("hidden") && e(a + 1, s + 1), i(d)) : 0 == l && (-1 == mineArr[a][s] && (c.hasClass("flag") || c.removeClass("hidden").addClass("bomb")), mineArr[a][s] > 0 && (c.hasClass("flag") ? c.removeClass("flag").addClass("wrong").html("") : c.removeClass("hidden").html(mineArr[a][s]).addClass("num" + mineArr[a][s])), 0 == mineArr[a][s] && c.removeClass("hidden"))
  }

  function a(r, e) {
    var a = $("#c" + r + "-r" + e);
    0 != l && (a.hasClass("hidden") || a.hasClass("flag") || a.hasClass("check") ? C ? a.hasClass("flag") ? (a.removeClass("flag").addClass("hidden"), c--, t++, m++, $("#restMine").text(t)) : (a.removeClass("hidden").addClass("flag"), c++, t--, m--, $("#restMine").text(t)) : a.hasClass("flag") ? (a.removeClass("flag").addClass("check").addClass("hidden"), c--, t++, m++, $("#restMine").text(t)) : a.hasClass("check") ? a.removeClass("check") : (a.removeClass("hidden").addClass("flag"), c++, t--, m--, $("#restMine").text(t)) : s(r, e))
  }

  function s(r, a) {
    for (var s = 0, n = ($("#c" + r + "-r" + a), a - 1); a + 2 > n; n++)
      for (var i = r - 1; r + 2 > i; i++) $("#c" + i + "-r" + n).hasClass("flag") && s++;
    if (s == mineArr[r][a])
      for (var n = a - 1; a + 2 > n; n++)
        for (var i = r - 1; r + 2 > i; i++) $("#c" + i + "-r" + n).hasClass("hidden") && e(i, n)
  }

  function n() {
    clearInterval(h), $("#alert").text("你输啦!"), l = 0;
    for (var r = 1; r < mineArr.length; r++)
      for (var a = 1; a < mineArr[0].length; a++) e(r, a)
  }

  function i(r) {
    if (r == c + m && (1 == l || 2 == l)) {
      clearInterval(h), $("#alert").text("你赢啦,时间是" + $("#time").text() + "s");
      for (var e = 1; e < mineArr.length; e++)
        for (var a = 1; a < mineArr[0].length; a++) - 1 == mineArr[e][a] && $("#c" + e + "-r" + a).addClass("flag");
      l = 0
    }
  }
  var l, d, h, t = 0,
    m = 0,
    c = 0,
    C = !0;
  $("#main").mouseup(function(r) {
    var s = $(r.target),
      n = s.attr("id"),
      l = parseInt(n.substring(1, n.indexOf("-"))),
      h = parseInt(n.substring(n.indexOf("r") + 1));
    1 == r.which ? e(l, h) : 3 == r.which && a(l, h), i(d)
  }), $("#main").bind("contextmenu", function() { return !1 }), $("#Baginner").click(function() { r(10, 10, 10) }), $("#Intermediate").click(function() { r(16, 16, 40) }), $("#Expert").click(function() { r(30, 16, 99) }), $("#Custom").click(function() {}), $("#ok").click(function() {
    var e = $("#text_height"),
      a = $("#text_width"),
      s = $("#text_mains"),
      n = parseInt(e.val()),
      i = parseInt(a.val()),
      l = parseInt(s.val());
    if (isNaN(n) || isNaN(i) || isNaN(l)) alert("三个数据都要填写哟~");
    else if (n > 131 || i > 131) alert("设置的太大了噢,加载会变很慢的!"), e.val(131), a.val(131), s.val(528);
    else {
      var d = Math.ceil(n * i * .99);
      l > d ? (alert("雷数太多啦!当前布局最多数量为" + d), s.val(d)) : r(n, i, l)
    }
  })
});